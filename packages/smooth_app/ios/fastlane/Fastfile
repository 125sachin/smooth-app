default_platform(:ios)
platform :ios do

  desc "Push a new beta build to TestFlight"
  lane :beta do

    APP_IDENTIFIER = CredentialsManager::AppfileConfig.try_fetch_value(:app_identifier)
    
    sync_code_signing(type: "appstore", readonly: is_ci, clone_branch_directly: false)
    update_code_signing_settings(
      path: "Runner.xcodeproj",
      use_automatic_signing: false,
      build_configurations: "Release",
      code_sign_identity: 'iPhone Distribution',
      profile_name: 'match AppStore org.openfoodfacts.app',
      targets: ["Runner"]
    )
  
    # build your iOS app
    gym(
      configuration: "Release",
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      export_options: {
          provisioningProfiles: {
              "org.openfoodfacts.app" => "match AppStore org.openfoodfacts.app", 
          }
      }
    )
  
    # Upload to test flight
    pilot(
      app_identifier: APP_IDENTIFIER,
      skip_submission: true,
      skip_waiting_for_build_processing: true,
      ipa: "./Runner.ipa"
    )
  end
end
